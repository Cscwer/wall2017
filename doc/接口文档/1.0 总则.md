1.0 总则 

本文件重在讲述 api 的公共约定。 

# 分层 API 

每一个接口都会遵从公共约定，而且在这基础上，还会有其他的约定，这是本接口集的一个重要特征。 

1. 在具体的约定里面不会有关于公共的约定的任何内容
2. 约定胜于配置 

# 一些特别说明 

在接口返回的数据中，请无视 `__v` 字段，这是 Mongoose 自己加上去的，无须理会。 

MongoDB 中每一条数据实例（专业术语是文档 document，可以看作是 SQL 的行），都会有一个 字段 `_id` 它的类型是 `ObjectId` 可以转为字符串，而且绝对唯一，不会重复，用作数据库索引，今后如果文档中提到 `id` 这样的字眼一般指的就是这个数据库自动创建的 `_id` 

# 关于 token 

我设置了加密的cookie作为token存储在前端， 对于前端来说完全透明（所有请求都会自动带上 cookie 即 token），不过这样一来接口便有了主语，这点需要注意。 

比如 eczn 登录了我们的应用，在调用接口的时候，我能识别出它是谁，因此在暗恋匹配的时候他只需要告诉我他喜欢谁就可以 无须他自称他是 eczn 。 

# 看懂数据库设计 

一般我会展示数据库的设计方便阅读者理解。 

读懂数据库不难，最重要的是要知道 `设计` 一词在代码中的体现： 

拿 `ta` 这张表来说： 

``` js
let taSchema = mongoose.Schema({
    from: {
        type: mongoose.Schema.Types.ObjectId,
        ref: 'user', 
        required: true, 
        unique: true
    }, 
    to: {
        type: mongoose.Schema.Types.ObjectId,
        ref: 'user', 
        required: true
    }, 
    created_at: {
        type: Date, 
        default: Date.now
    }
});
```

那陀对象描述了该表里面应该存储的数据类型： 

document 可以有 from, to, created_at 这些字段，其中 from, to 是必填的，此外 from 还是唯一的(unique), 而且 from 字段的类型是 ObjectId 它链接到 `user` 这张表上，记录着某个用户的 `_id` 

还有就是 create_at 的 default 字段，它可以是字符串，作为存入数据库的默认值，也可以是函数，在存入数据库的时候 Mongoose 会自动调用这个函数得到结果作为默认值存入数据库 

还有什么不懂的，欢迎提问。 

# 公共状态码

## 位阶特性

1. 2000 ~ 2999 表示 API 服务正常
2. 4000 ~ 4999 表示客户端异常，比如发送了不合法的数据
3. 5000 ~ 5999 表示服务器异常，比如数据库保存失败

以上会在调用接口的时候返回，特别地，一旦你能看到上面的这种大于1000的状态码，说明 HTTP 本身工作正常，即客户端和服务器能正常交流（即状态码 200 OK），之所以再设更多的状态码，是为了进一步描述 `200 OK` 的内涵。 

## 百位数的说明

比如 4100 ~ 4999 这段百位数不为0的区间的表示的错误一般不是公共的错误，一般只会发生在特定的接口上，比如 4100 表示 “请勿暗恋自己喔”，此错误只会出现在暗恋匹配那里。

相反 4x00 这些是常见错误，比如数据输入不合法，或者重复保存这样。 

## 状态码详细说明

相关源码可以看 `./server/utils/rps/index.js` 里面有全部的状态码。 

``` js
let code2msg = {
    2000: '接口调用成功', 
    4000: '参数错误, 请检查输入',
    4001: 'token 无效或过期', 
    4004: '查询无结果, 接口调用失败', 
    4005: '该接口只能调用一次请勿重复调用',
    4003: '权限不足, 拒绝访问', 

    4100: '请勿暗恋自己喔', 

    5000: '内部错误', 
    5005: '数据库错误', 
    5006: 'MP3 解码内部错误', 
    2002: '已受理 接口忙绿 请递归轮询', 
    5099: '未知错误，请联系我'
}
```
