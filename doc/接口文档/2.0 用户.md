2.0 用户 

本文件重在说明许愿墙的用户系统和应用的入口逻辑 


# 用户授权 

应用的 `index.html` 在 `/` 上，可以直接访问，这时候有三种情况： 

1. 用户从未授权过
2. 用户授权过，但清空了 cookie 
3. 用户授权过，cookie 有效 

第一种情况下，会重定向到 `/api/entry` 进行授权注册

第二种情况也与第一种情况一样，但是不会覆盖之前存储在数据库中的记录，而是重新派一个 cookie 

第三种情况，读取 cookie 的内容，得知用户身份 


为了安全，对 cookie 进行了 jwt 加密 

# 数据库设计 
用户表 user 的设计： 

``` js
let userSchema = mongoose.Schema({
    // WX_USER_INFO
    openid: {
        type: String, 
        required: true,
        // 唯一性保障
        unique: true
    },
    nickname: {
        type: String, 
        required: true
    },
    sex: {
        type: Number, 
        required: true
    },
    headimgurl: {
        type: String, 
        required: true
    },
    phone: {
        type: String, 
        max: 11, 
        default: '未设置'
    },
    weid: {
        tpye: String
    },
    created_at: {
        type: Date, 
        default: Date.now
    }
});
```

1. `openid` 是用户在微信的 id，对特定的一个公众号而言，是绝无重复的
2. nickname 表示用户微信名 
3. sex 表示性别 
4. headimgurl 头像
5. phone 手机号, 非必填，无法直接自动取得，需要用户输入 
6. weid 微信号，同上，需要用户自己输入 
7. created_at 创建时间

# 可用接口 

对于 user 表的操作主要是 `/api/user/*` 下的操作。 

1. /api/user/me 
2. /api/user


## GET /api/user/me 

**[ TIP ]** 获取用户个人信息，无须参数直接调用

**[ RESPONSE ]** 返回值参考 

``` json
{
    "code": 2000,
    "data": {
        "__v": 0,
        "openid": "opdbdwdWXWMg9UY72Z4i_DTcblR0",
        "nickname": "eczn",
        "sex": 0,
        "headimgurl": "头像地址",
        "_id": "59ce826c4fece5203cd318c7",
        "created_at": "2017-09-29T17:27:08.773Z",
        "phone": "未设置"
    },
    "msg": "接口调用成功"
}
```

## GET /api/user 

**[ TIP ]** 在 user 表中模糊查询 nickname 和 phone 字段 

特别需要注意的是，返回值的有效值是数组，里面是用户。 

而且，该数组最大长度为 `10` 本接口没有分页 

此外，该接口比较消耗性能，请勿频繁调用 （做好函数截流）

**[ PARAM ]** 需要参数，如下： 

``` js
http.get('/api/user', {
    q: 'e'
})
```

字段 `q` 是 `query` 的缩写

**[ RESPONSE ]** 返回值参考 

res.data 是数组，用户都在里面

``` json
{
    "code": 2000,
    "data": [
        {
            "_id": "59ce826c4fece5203cd318c7",
            "openid": "opdbdwdWXWMg9UY72Z4i_DTcblR0",
            "nickname": "eczn",
            "sex": 0,
            "headimgurl": "头像啦",
            "__v": 0,
            "created_at": "2017-09-29T17:27:08.773Z",
            "phone": "未设置"
        },
        {
            "_id": "59ce82b6013ab732301dc8d7",
            "openid": "002-openid-fake",
            "nickname": "我是eczn的爱人",
            "sex": 0,
            "headimgurl": "头像啦",
            "__v": 0,
            "created_at": "2017-09-29T17:28:22.850Z",
            "phone": "未设置"
        }
    ],
    "msg": "接口调用成功"
}
```

## POST /api/user/update 

**[ TIP ]** 根据所给字段更新用户数据 

而且，更新之后，将会返回新用户数据，而且 token 也会更新，里面携带着最新的用户数据。


**[ PARAM ]** user 表中的字段均可以作为参数 

``` js
http.post('/api/user/update', {
    nickname: '新名字' 
}); 
```

以上只更新用户名。


**[ RESPONSE ]** 返回值参考 

``` json
{
    "code": 2000,
    "data": {
        "_id": "59ce826c4fece5203cd318c7",
        "openid": "opdbdwdWXWMg9UY72Z4i_DTcblR0",
        "nickname": "fuck",
        "sex": 0,
        "headimgurl": "头像地址",
        "__v": 0,
        "created_at": "2017-09-29T17:27:08.773Z",
        "phone": "未设置"
    },
    "msg": "接口调用成功"
}
```
